<!-- This is the config node for the mappings -->
<script type="text/x-red" data-template-name="mappings-config">
	<div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-keyName"><i class="icon-tag"></i> Key Name</label>
        <input type="text" id="node-config-input-keyName" placeholder="Key Name">
    </div>
	<div class="form-row">
        <label for="node-config-input-valueName"><i class="icon-tag"></i> Value Name</label>
        <input type="text" id="node-config-input-valueName" placeholder="Value Name">
    </div>
    <div class="form-row node-config-input-mapping-container-row">
        <ol id="node-config-input-mapping-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="mappings-config">
<p>
Configure the mappings
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('mappings-config', {
        category: 'config',
        defaults: {
        	name: {value:"", required:true},
        	keyName: {value:"key", required:true},
        	valueName: {value:"value", required:true},
        	mappings: {value:[{key:"key", value:"value"}]}
        },
        label: function () {
            return this.name;
        },
        oneditprepare: function() {
            var node = this;
            $("#node-config-input-mapping-container").css('min-height','250px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                	var mapping = opt.mapping || {key:node.keyName, value:node.valueName};
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);
                    var keyField = $('<input/>',{class:"node-config-input-mapping-key",type:"text",style:"width:40%; margin-left: 5px;"}).appendTo(row).val(mapping.key);
                    var valueField = $('<input/>',{class:"node-config-input-mapping-value",type:"text",style:"width:40%; margin-left: 5px;"}).appendTo(row).val(mapping.value);
                    var finalspan = $('<span/>',{style:"float: right;margin-top: 6px;"}).appendTo(row);
                    finalspan.append(' &#8594; <span class="node-config-input-mapping-index">'+(i+1)+'</span> ');
                },
                removeItem: function(opt) {
                    var mappings = $("#node-config-input-mapping-container").editableList('items');
                    mappings.each(function(i) {
                        $(this).find(".node-config-input-mapping-index").html(i+1);
                        var data = $(this).data('data');
                    });
                },
                sortable: false,
                removable: true
            });

            for (var i=0;i<this.mappings.length;i++) {
                var mapping = this.mappings[i];
                $("#node-config-input-mapping-container").editableList('addItem',{mapping:mapping,i:i});
            }
        },
        oneditsave: function() {
            var mappings = $("#node-config-input-mapping-container").editableList('items');
            var mappingset;
            var node = this;
            node.mappings = [];
            mappings.each(function(i) {
                var mappingData = $(this).data('data');
                var mapping = $(this);
                var r = {};
                r.key = mapping.find(".node-config-input-mapping-key").val();
                r.value = mapping.find(".node-config-input-mapping-value").val();
                node.mappings.push(r);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-config-input-mapping-container-row)");
            var height = size.height;
            for (var i=0;i<rows.size();i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-config-input-mapping-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#node-config-input-mapping-container").editableList('height',height);
        }
    });
</script>




<!-- This node allows for mapping message properties -->
<script type="text/x-red" data-template-name="mappings-map">
	<div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row node-input-config">
        <label for="node-input-config"><i class="icon-bullhorn"></i> Mapping</label>
        <input type="text" id="node-input-config">
    </div>
    <hr/>
	<div class="form-row">
        <label for="node-input-inKeyOrValue"><i class="fa fa-ellipsis-h"></i> Get</label>
		<select id="node-input-inKeyOrValue" style="width:250px;">
            <option value="key">key</option>
            <option value="value">value</option>
        </select>
	</div>
	<div class="form-row">
		<label for="node-input-in"><i class="fa fa-ellipsis-h"></i> From</label>
        <input type="text" id="node-input-in" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-inType">
    </div>
    <hr/>
	<div class="form-row">
        <label for="node-input-outKeyOrValue"><i class="fa fa-ellipsis-h"></i> Set</label>
		<select id="node-input-outKeyOrValue" style="width:250px;background: #eee;cursor:no-drop;">
            <option style="display:none" value="key">key</option>
            <option style="display:none" value="value">value</option>
        </select>
	</div>
	<div class="form-row">
		<label for="node-input-out"><i class="fa fa-ellipsis-h"></i> On</label>
        <input type="text" id="node-input-out" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-outType">
    </div>
	<hr/>
	<div class="form-row">
        <label for="node-input-caseInsensitive"><i class="fa fa-tag"></i> Ignore Case</label>
        <input type="checkbox" id="node-input-caseInsensitive">
    </div>
</script>

<!-- Help text for map -->
<script type="text/x-red" data-help-name="mappings-map">
<p>
TODO
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('mappings-map', {
        category: 'mappings',
        defaults: {
            name: {value:""},
            config: {value:"", type:"mappings-config", required:true},
            in: {value:"payload", validate:RED.validators.typedInput("inType"), required:true},
            inType: {value:"msg", required:true},
            inKeyOrValue: {value:"key", required:true},
            out: {value:"payload", validate:RED.validators.typedInput("outType"), required:true},
            outType: {value:"msg", required:true},
            outKeyOrValue: {value:"value", required:true},
        	caseInsensitive: {value:true}
        },
        color:"#E2D96E",
        inputs:1,
        outputs:1,
        icon: "swap.png",
        label: function () {
            return this.name || "Map";
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
        	var node = this;
            if (!node.in) {
                node.in = 'payload';
                $("#node-input-in").val("payload");
            }
            if (!node.inType) {
                node.inType = 'msg';
            }
            if (!node.inKeyOrValue) {
            	node.inKeyOrValue = 'key';
            }
            
            $('#node-input-inKeyOrValue').change(function() {
            	$('#node-input-outKeyOrValue').val( $(this).val()==='value' ? 'key' : 'value' );
            });
            
            $("#node-input-in").typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $("#node-input-inType")
            });
            if (!node.out) {
                node.out = 'payload';
                $("#node-input-out").val("payload");
            }
            if (!node.outType) {
                node.outType = 'msg';
            }
            if (!node.outKeyOrValue) {
            	node.outKeyOrValue = node.inKeyOrValue==='value' ? 'key' : 'value';
            }
            
            $("#node-input-out").typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $("#node-input-outType")
            });
            
            $("#node-input-config").change(function() {
            	var config = RED.nodes.node($(this).val());
            	if (config) {
	            	$('#node-input-inKeyOrValue option[value="key"]').text(config.keyName);
	                $('#node-input-inKeyOrValue option[value="value"]').text(config.valueName);
	                $('#node-input-outKeyOrValue option[value="key"]').text(config.keyName);
	                $('#node-input-outKeyOrValue option[value="value"]').text(config.valueName);
            	}
            });
            
            $("#node-input-config").change();
            
        }

    });
</script>




<!-- This node allows for setting a message property based on a given mapping -->
<script type="text/x-red" data-template-name="mappings-set">
	<div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row node-input-config">
        <label for="node-input-config"><i class="icon-bullhorn"></i> Mapping</label>
        <input type="text" id="node-input-config">
    </div>
    <hr/>
	<div class="form-row">
		<label for="node-input-from"><i class="fa fa-ellipsis-h"></i> From</label>
        <select id="node-input-from" style="width:250px;"/>
    </div>
	<div class="form-row">
        <label for="node-input-outKeyOrValue"><i class="fa fa-ellipsis-h"></i> Set</label>
		<select id="node-input-outKeyOrValue" style="width:250px;">
            <option value="key">key</option>
            <option value="value">value</option>
        </select>
	</div>
	<div class="form-row">
		<label for="node-input-out"><i class="fa fa-ellipsis-h"></i> On</label>
        <input type="text" id="node-input-out" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-outType">
    </div>
</script>

<!-- Help text for map -->
<script type="text/x-red" data-help-name="mappings-set">
<p>
TODO
</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('mappings-set', {
        category: 'mappings',
        defaults: {
            name: {value:""},
            config: {value:"", type:"mappings-config", required:true},
            from: {value:"", required:true},
            out: {value:"payload", validate:RED.validators.typedInput("outType"), required:true},
            outType: {value:"msg", required:true},
            outKeyOrValue: {value:"value", required:true}
        },
        color:"#E2D96E",
        inputs:1,
        outputs:1,
        icon: "swap.png",
        label: function () {
            return this.name || "Set";
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
        	var node = this;
            
            if (!node.out) {
                node.out = 'payload';
                $("#node-input-out").val("payload");
            }
            if (!node.outType) {
                node.outType = 'msg';
            }
            if (!node.outKeyOrValue) {
            	node.outKeyOrValue = 'value';
            }
            
            $("#node-input-out").typedInput({
                default: 'msg',
                types: ['msg'],
                typeField: $("#node-input-outType")
            });
            
            $("#node-input-config").change(function() {
            	var config = RED.nodes.node($(this).val());
            	var $mySelect = $('#node-input-from');
            	$mySelect.children().remove().end()
            	if (config) {
            		$('#node-input-outKeyOrValue option[value="key"]').text(config.keyName);
 	                $('#node-input-outKeyOrValue option[value="value"]').text(config.valueName);
         			$.each(config.mappings, function(i, mapping) {
	         			var $option = $("<option/>", {
	         			    value: mapping.key,
	         			    text: mapping.key+' - '+mapping.value
	         			});
	         			$mySelect.append($option);
         			});
            	}
            });
            
            $("#node-input-config").change();
            
        }

    });
</script>